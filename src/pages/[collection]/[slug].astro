---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import MarkdownEntry from "../../components/MarkdownEntry.astro";
import EntryNavigation from "../../components/EntryNavigation.astro";
import { COLLECTION_TYPES, COLLECTION_LABELS, type ValidCollection } from "../../utils/constants";
import { getAdjacentEntries } from "../../utils/entryUtils";

// Union type for entries from any valid collection
type AnyEntry = CollectionEntry<ValidCollection>;

// Generate static paths for all entries across all collections
export async function getStaticPaths() {
  const paths: Array<{
    params: { collection: string; slug: string };
    props: { entry: AnyEntry; collectionName: ValidCollection };
  }> = [];

  for (const collectionName of COLLECTION_TYPES) {
    const entries = await getCollection(collectionName);
    for (const entry of entries) {
      paths.push({
        params: { collection: collectionName, slug: entry.slug },
        props: { entry: entry as AnyEntry, collectionName },
      });
    }
  }

  return paths;
}

interface Props {
  entry: AnyEntry;
  collectionName: ValidCollection;
}

const { entry, collectionName } = Astro.props;

// Load all collections for sidebar navigation
const mysqlEntries = await getCollection("mysql");
const mssqlEntries = await getCollection("mssql");
const oracleEntries = await getCollection("oracle");
const postgresqlEntries = await getCollection("postgresql");
const extrasEntries = await getCollection("extras");

// Build page title
const collectionTitle = COLLECTION_LABELS[collectionName];
const pageTitle = `${entry.data.title} | ${collectionTitle} | SQL Injection KB`;

// Build collections object for Layout - includes all collections for sidebar navigation
const collections = {
  mysqlEntries,
  mssqlEntries,
  oracleEntries,
  postgresqlEntries,
  extrasEntries,
};

// Get current collection entries for navigation
const collectionEntriesMap: Record<ValidCollection, AnyEntry[]> = {
  mysql: mysqlEntries,
  mssql: mssqlEntries,
  oracle: oracleEntries,
  postgresql: postgresqlEntries,
  extras: extrasEntries,
};
const currentCollectionEntries = collectionEntriesMap[collectionName];
const { previous, next } = getAdjacentEntries(currentCollectionEntries, entry.slug);
---

<Layout title={pageTitle} collections={collections}>
  <div class="entry-container" transition:animate="slide">
    <div class="entry-header" transition:animate="fade">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href={import.meta.env.BASE_URL}>Home</a>
        <span class="separator" aria-hidden="true">/</span>
        <a href={`${import.meta.env.BASE_URL}${collectionName}/intro`}>{collectionTitle}</a>
        <span class="separator" aria-hidden="true">/</span>
        <span aria-current="page">{entry.data.title}</span>
      </nav>
    </div>

    <MarkdownEntry entry={entry} />

    <EntryNavigation collection={collectionName} previous={previous} next={next} />
  </div>
</Layout>

<style>
  .entry-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .entry-header {
    margin-bottom: 1.5rem;
  }

  .breadcrumbs {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-light);
  }

  .breadcrumbs a {
    color: var(--color-primary);
    text-decoration: none;
  }

  .breadcrumbs a:hover {
    text-decoration: underline;
  }

  .separator {
    color: var(--color-border-light);
  }
</style>
