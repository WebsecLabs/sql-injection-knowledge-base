---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import MarkdownEntry from "../../components/MarkdownEntry.astro";
import BackLink from "../../components/BackLink.astro";
import { COLLECTION_TYPES, COLLECTION_LABELS, type ValidCollection } from "../../utils/constants";

// Union type for entries from any valid collection
type AnyEntry = CollectionEntry<ValidCollection>;

// Generate static paths for all entries across all collections
export async function getStaticPaths() {
  const paths: Array<{
    params: { collection: string; slug: string };
    props: { entry: AnyEntry; collectionName: ValidCollection };
  }> = [];

  for (const collectionName of COLLECTION_TYPES) {
    const entries = await getCollection(collectionName);
    for (const entry of entries) {
      paths.push({
        params: { collection: collectionName, slug: entry.slug },
        props: { entry: entry as AnyEntry, collectionName },
      });
    }
  }

  return paths;
}

interface Props {
  entry: AnyEntry;
  collectionName: ValidCollection;
}

const { entry, collectionName } = Astro.props;

// Load all collections for sidebar navigation
const mysqlEntries = await getCollection("mysql");
const mssqlEntries = await getCollection("mssql");
const oracleEntries = await getCollection("oracle");
const postgresqlEntries = await getCollection("postgresql");
const extrasEntries = await getCollection("extras");

// Build page title
const collectionTitle = COLLECTION_LABELS[collectionName];
const pageTitle = `${entry.data.title} | ${collectionTitle} | SQL Injection KB`;

// Build collections object for Layout - includes all collections for sidebar navigation
const collections = {
  mysqlEntries,
  mssqlEntries,
  oracleEntries,
  postgresqlEntries,
  extrasEntries,
};
---

<Layout title={pageTitle} collections={collections}>
  <MarkdownEntry entry={entry} />
  <BackLink />
</Layout>
