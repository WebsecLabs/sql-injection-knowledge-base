---
import { getCollection, type CollectionEntry } from "astro:content";
import { ClientRouter } from "astro:transitions";
import NavBar from "../components/NavBar.astro";
import Sidebar from "../components/Sidebar.astro";
import websecLogo from "../assets/websec-logo.png";

// Import CSS files
import "../styles/main.css";
import "../styles/navbar.css";
import "../styles/code.css";

import "@fontsource/inter/400.css";
import "@fontsource/inter/500.css";
import "@fontsource/inter/600.css";
import "@fontsource/inter/700.css";
import "@fontsource/jetbrains-mono/400.css";
import "@fontsource/jetbrains-mono/500.css";

interface Props {
  title: string;
  description?: string;
  showSidebar?: boolean;
  // Allow pages to pass their own collections to avoid duplicate loading
  collections?: {
    mysqlEntries?: CollectionEntry<"mysql">[];
    mariadbEntries?: CollectionEntry<"mariadb">[];
    mssqlEntries?: CollectionEntry<"mssql">[];
    oracleEntries?: CollectionEntry<"oracle">[];
    postgresqlEntries?: CollectionEntry<"postgresql">[];
    extrasEntries?: CollectionEntry<"extras">[];
  };
}

const {
  title,
  description = "The SQL Injection Knowledge Base is a comprehensive reference and educational resource on identifying, testing, and preventing SQL injection vulnerabilities across various database systems.",
  showSidebar = true,
  collections,
} = Astro.props;

// Load collections only if not provided by the page
const mysqlEntries = collections?.mysqlEntries ?? (await getCollection("mysql"));
const mariadbEntries = collections?.mariadbEntries ?? (await getCollection("mariadb"));
const mssqlEntries = collections?.mssqlEntries ?? (await getCollection("mssql"));
const oracleEntries = collections?.oracleEntries ?? (await getCollection("oracle"));
const postgresqlEntries = collections?.postgresqlEntries ?? (await getCollection("postgresql"));
const extrasEntries = collections?.extrasEntries ?? (await getCollection("extras"));
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <link rel="icon" type="image/png" href={`${import.meta.env.BASE_URL}favicon.png`} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta
      name="keywords"
      content="SQL Injection, SQLi, Knowledge Base, KB, CS, PR, MySQL, MSSQL, Oracle, PostgreSQL, SQLite, MS Access, Cheatsheet, Pocket Reference"
    />
    <meta name="HandheldFriendly" content="true" />

    <!-- Theme initialization - runs before page renders to prevent flash -->
    <script is:inline>
      (function () {
        const theme = localStorage.getItem("theme");
        if (theme === "dark") {
          document.documentElement.classList.add("dark");
        } else if (theme === "light") {
          document.documentElement.classList.add("light");
        }
      })();
    </script>

    <script>
      import "../scripts/main.ts";
    </script>
    <ClientRouter />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL("og-image.jpg", Astro.site)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL("og-image.jpg", Astro.site)} />

    <style is:global>
      @view-transition {
        navigation: auto;
      }

      .skip-link {
        position: absolute;
        top: -40px;
        left: 0;
        background: #1a56db; /* Darker blue for WCAG AA contrast (7:1 with white) */
        color: white;
        padding: 8px;
        z-index: 100;
        transition: top 0.2s;
        text-decoration: none;
        font-weight: bold;
        border-bottom-right-radius: 6px;
      }

      .skip-link:focus {
        top: 0;
        outline: 2px solid var(--color-accent);
      }
    </style>
  </head>
  <body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <NavBar
      mysqlEntries={mysqlEntries}
      mariadbEntries={mariadbEntries}
      mssqlEntries={mssqlEntries}
      oracleEntries={oracleEntries}
      postgresqlEntries={postgresqlEntries}
      extrasEntries={extrasEntries}
    />

    <div class="page-layout">
      {
        showSidebar && (
          <>
            <div id="sidebar-overlay" class="sidebar-overlay" />
            <Sidebar
              mysqlEntries={mysqlEntries}
              mariadbEntries={mariadbEntries}
              mssqlEntries={mssqlEntries}
              oracleEntries={oracleEntries}
              postgresqlEntries={postgresqlEntries}
              extrasEntries={extrasEntries}
            />
          </>
        )
      }

      {/* Mobile-only button container - only visible when sidebar should be shown */}
      {
        showSidebar && (
          <div class="button-container">
            <button id="sidebar-toggle" class="sidebar-toggle" aria-label="Toggle navigation">
              <div class="hamburger-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="white"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="3" y1="12" x2="21" y2="12" />
                  <line x1="3" y1="6" x2="21" y2="6" />
                  <line x1="3" y1="18" x2="21" y2="18" />
                </svg>
              </div>
            </button>
          </div>
        )
      }

      <main id="main-content" tabindex="-1" class="main-content">
        <div class="content-container">
          <slot />
        </div>
      </main>
    </div>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-branding">
            <span class="footer-text">Powered by</span>
            <div class="footer-logo">
              <a
                href="https://www.websec.com"
                target="_blank"
                rel="noopener noreferrer"
                class="footer-logo-link"
              >
                <img
                  src={websecLogo.src}
                  alt="Websec Logo"
                  class="footer-logo-img"
                  loading="lazy"
                />
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </body>
</html>
