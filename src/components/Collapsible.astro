---
interface Props {
  title: string;
  defaultOpen?: boolean;
}

const { title, defaultOpen = false } = Astro.props;

// Generate unique ID using crypto.randomUUID() for guaranteed uniqueness
const contentId = `collapsible-content-${crypto.randomUUID()}`;
---

<div class={`collapsible ${defaultOpen ? "active" : ""}`}>
  <button
    type="button"
    class="collapsible-header"
    aria-expanded={defaultOpen}
    aria-controls={contentId}
  >
    <span>{title}</span>
    <span class="collapsible-icon" aria-hidden="true">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </span>
  </button>
  <div id={contentId} class="collapsible-content">
    <slot />
  </div>
</div>

<script>
  declare global {
    interface Window {
      __collapsibleInitialized?: boolean;
    }
  }

  function initCollapsibles() {
    // Guard against multiple initializations
    if (window.__collapsibleInitialized) return;
    window.__collapsibleInitialized = true;

    // Use event delegation with a single global handler
    document.addEventListener("click", (e) => {
      if (!(e.target instanceof Element)) return;
      const header = e.target.closest(".collapsible-header");
      if (!header) return;

      const collapsible = header.closest(".collapsible");
      if (!collapsible) return;

      const isActive = collapsible.classList.toggle("active");
      header.setAttribute("aria-expanded", String(isActive));
    });
  }

  // Initialize immediately if DOM is ready, otherwise wait for DOMContentLoaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCollapsibles);
  } else {
    initCollapsibles();
  }
</script>

<style>
  .collapsible-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.75rem 1rem;
    border: none;
    background: var(--color-bg-secondary, #f5f5f5);
    cursor: pointer;
    font: inherit;
    text-align: left;
  }

  .collapsible-header:focus-visible {
    outline: 2px solid var(--color-primary, #0066cc);
    outline-offset: 2px;
  }

  .collapsible-icon {
    transition: transform 0.3s ease;
  }

  .collapsible.active .collapsible-icon {
    transform: rotate(180deg);
  }

  .collapsible-content {
    display: none;
  }

  .collapsible.active .collapsible-content {
    display: block;
  }
</style>
