---
interface Props {
  defaultTab?: string;
}

const { defaultTab } = Astro.props;
---

<div class="tabs" data-default-tab={defaultTab}>
  <ul class="tab-list" role="tablist">
    <slot name="tab-list" />
  </ul>

  <div class="tab-contents">
    <slot />
  </div>
</div>

<script>
  // Track initialized containers to prevent duplicate event listeners
  const initializedContainers = new WeakSet<Element>();

  // Initialize tabs with ARIA attributes and keyboard support
  function initializeTabs() {
    const tabContainers = document.querySelectorAll(".tabs");

    tabContainers.forEach((tabContainer) => {
      // Skip if already initialized (prevents memory leaks from duplicate listeners)
      if (initializedContainers.has(tabContainer)) {
        return;
      }
      initializedContainers.add(tabContainer);

      const tabList = tabContainer.querySelector('[role="tablist"]');
      const tabs = Array.from(tabContainer.querySelectorAll(".tab-item"));
      const panels = tabContainer.querySelectorAll(".tab-content");
      const defaultTabId = tabContainer.getAttribute("data-default-tab");

      // Generate unique IDs and set up ARIA attributes
      const containerId = `tabs-${Math.random().toString(36).slice(2, 9)}`;

      tabs.forEach((tab, index) => {
        const tabId = tab.getAttribute("data-tab") || `tab-${index}`;
        const tabElementId = `${containerId}-tab-${tabId}`;
        const panelElementId = `${containerId}-panel-${tabId}`;

        // Set tab ARIA attributes
        tab.setAttribute("role", "tab");
        tab.setAttribute("id", tabElementId);
        tab.setAttribute("aria-controls", panelElementId);
        tab.setAttribute("tabindex", "-1");

        // Find and set up the corresponding panel
        const panel = tabContainer.querySelector(
          `.tab-content[data-tab="${tabId}"]`
        ) as HTMLElement | null;
        if (panel) {
          panel.setAttribute("role", "tabpanel");
          panel.setAttribute("id", panelElementId);
          panel.setAttribute("aria-labelledby", tabElementId);
          panel.setAttribute("aria-hidden", "true");
          panel.setAttribute("tabindex", "0");
        }
      });

      // Determine which tab to activate (priority: defaultTab > existing .active > first tab)
      let activeTabIndex = 0;

      // Check for pre-existing active class (fallback if no defaultTab)
      const existingActiveIndex = tabs.findIndex((tab) => tab.classList.contains("active"));
      if (existingActiveIndex !== -1) {
        activeTabIndex = existingActiveIndex;
      }

      // Override with defaultTab prop if provided
      if (defaultTabId) {
        const defaultIndex = tabs.findIndex((tab) => tab.getAttribute("data-tab") === defaultTabId);
        if (defaultIndex !== -1 && defaultIndex < tabs.length) {
          activeTabIndex = defaultIndex;
        }
      }

      // Activate the determined tab
      activateTab(tabContainer, tabs, panels, activeTabIndex);

      // Add click event listeners
      tabs.forEach((tab, index) => {
        tab.addEventListener("click", () => {
          activateTab(tabContainer, tabs, panels, index);
        });
      });

      // Add keyboard navigation
      if (tabList) {
        tabList.addEventListener("keydown", ((e: KeyboardEvent) => {
          const currentIndex = tabs.findIndex((tab) => tab === document.activeElement);
          if (currentIndex === -1) return;

          let newIndex = currentIndex;

          switch (e.key) {
            case "ArrowRight":
              e.preventDefault();
              newIndex = (currentIndex + 1) % tabs.length;
              break;
            case "ArrowLeft":
              e.preventDefault();
              newIndex = (currentIndex - 1 + tabs.length) % tabs.length;
              break;
            case "Home":
              e.preventDefault();
              newIndex = 0;
              break;
            case "End":
              e.preventDefault();
              newIndex = tabs.length - 1;
              break;
            case "Enter":
            case " ":
              e.preventDefault();
              activateTab(tabContainer, tabs, panels, currentIndex);
              return;
            default:
              return;
          }

          // Move focus and activate the new tab
          (tabs[newIndex] as HTMLElement).focus();
          activateTab(tabContainer, tabs, panels, newIndex);
        }) as EventListener);
      }
    });
  }

  function activateTab(
    container: Element,
    tabs: Element[],
    panels: NodeListOf<Element>,
    activeIndex: number
  ) {
    // Update all tabs
    tabs.forEach((tab, index) => {
      const isActive = index === activeIndex;
      tab.classList.toggle("active", isActive);
      tab.setAttribute("aria-selected", String(isActive));
      tab.setAttribute("tabindex", isActive ? "0" : "-1");
    });

    // Update all panels
    panels.forEach((panel) => {
      const tabId = panel.getAttribute("data-tab");
      const activeTabId = tabs[activeIndex]?.getAttribute("data-tab");
      const isActive = tabId === activeTabId;

      panel.classList.toggle("active", isActive);
      panel.setAttribute("aria-hidden", String(!isActive));
    });
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", initializeTabs);

  // Re-initialize after Astro View Transitions
  document.addEventListener("astro:page-load", initializeTabs);
</script>
