---
/**
 * NavBar Component
 * Main navigation bar that composes sub-components for modularity
 *
 * Sub-components:
 * - NavLogo: Site branding with responsive text
 * - NavSearch: Search input field
 * - NavDatabasesDropdown: Database navigation mega-menu
 * - NavExtrasDropdown: Extras/resources dropdown
 * - NavGitHubLink: GitHub repository link
 * - NavThemeToggle: Dark/light theme switcher
 * - NavMobileToggle: Hamburger menu for mobile
 */
import { type CollectionEntry } from "astro:content";
import type { DatabaseCollection } from "../utils/constants";
import {
  groupByCategory,
  sortGroupedEntriesInPlace,
  getSortedCategories,
} from "../utils/entryUtils";
import { createActiveChecker } from "../utils/pathUtils";

// Sub-components
import NavLogo from "./navbar/NavLogo.astro";
import NavSearch from "./navbar/NavSearch.astro";
import NavDatabasesDropdown from "./navbar/NavDatabasesDropdown.astro";
import NavExtrasDropdown from "./navbar/NavExtrasDropdown.astro";
import NavGitHubLink from "./navbar/NavGitHubLink.astro";
import NavThemeToggle from "./navbar/NavThemeToggle.astro";
import NavMobileToggle from "./navbar/NavMobileToggle.astro";

interface Props {
  mysqlEntries?: CollectionEntry<"mysql">[];
  mariadbEntries?: CollectionEntry<"mariadb">[];
  mssqlEntries?: CollectionEntry<"mssql">[];
  oracleEntries?: CollectionEntry<"oracle">[];
  postgresqlEntries?: CollectionEntry<"postgresql">[];
  extrasEntries?: CollectionEntry<"extras">[];
}

// Get entries from props, defaulting to empty arrays
const {
  mysqlEntries = [],
  mariadbEntries = [],
  mssqlEntries = [],
  oracleEntries = [],
  postgresqlEntries = [],
  extrasEntries = [],
} = Astro.props;

// Group and sort entries by category using shared utilities
const entriesByCategory: Record<
  DatabaseCollection,
  Record<string, CollectionEntry<DatabaseCollection>[]>
> = {
  mysql: sortGroupedEntriesInPlace(groupByCategory(mysqlEntries)),
  mariadb: sortGroupedEntriesInPlace(groupByCategory(mariadbEntries)),
  mssql: sortGroupedEntriesInPlace(groupByCategory(mssqlEntries)),
  oracle: sortGroupedEntriesInPlace(groupByCategory(oracleEntries)),
  postgresql: sortGroupedEntriesInPlace(groupByCategory(postgresqlEntries)),
};

// Get sorted category names for each type
const categoriesByType: Record<DatabaseCollection, string[]> = {
  mysql: getSortedCategories(entriesByCategory.mysql),
  mariadb: getSortedCategories(entriesByCategory.mariadb),
  mssql: getSortedCategories(entriesByCategory.mssql),
  oracle: getSortedCategories(entriesByCategory.oracle),
  postgresql: getSortedCategories(entriesByCategory.postgresql),
};

// Filter out external links from extras
const resourceLinks = extrasEntries.filter((entry) => entry.data.title === "External Resources");
const otherExtras = extrasEntries.filter((entry) => entry.data.title !== "External Resources");

// Current path to highlight active link
const currentPath = Astro.url.pathname;

// Create active path checker using shared utility
const isActivePath = createActiveChecker(currentPath, import.meta.env.BASE_URL);

// Base URL for links
const baseUrl = import.meta.env.BASE_URL;
---

<nav class="navbar">
  <div class="container">
    <NavLogo baseUrl={baseUrl} />

    <div class="navbar-menu" id="navbar-menu">
      <NavSearch baseUrl={baseUrl} />

      <ul class="nav-links">
        <NavDatabasesDropdown
          entriesByCategory={entriesByCategory}
          categoriesByType={categoriesByType}
          baseUrl={baseUrl}
          isActivePath={isActivePath}
        />

        <NavExtrasDropdown
          otherExtras={otherExtras}
          resourceLinks={resourceLinks}
          baseUrl={baseUrl}
          isActivePath={isActivePath}
        />

        <NavGitHubLink />

        <NavThemeToggle />
      </ul>
    </div>

    <NavMobileToggle />
  </div>
</nav>

<script>
  // NavBar functionality extracted to external module for maintainability
  import "../scripts/navbar.ts";
</script>
