---
/**
 * Sidebar component - Main navigation sidebar with collapsible sections.
 * Uses SidebarSection component to avoid code duplication.
 */
import { type CollectionEntry } from "astro:content";
import SidebarSection from "./SidebarSection.astro";

interface Props {
  mysqlEntries: CollectionEntry<"mysql">[];
  mssqlEntries: CollectionEntry<"mssql">[];
  oracleEntries: CollectionEntry<"oracle">[];
  postgresqlEntries: CollectionEntry<"postgresql">[];
  extrasEntries: CollectionEntry<"extras">[];
}

const { mysqlEntries, mssqlEntries, oracleEntries, postgresqlEntries, extrasEntries } = Astro.props;

// Type-safe helper function to group entries by category
type AnyEntry = CollectionEntry<"mysql" | "mssql" | "oracle" | "postgresql" | "extras">;

interface CategoryGroup {
  [category: string]: AnyEntry[];
}

function groupByCategory<T extends AnyEntry>(entries: T[]): CategoryGroup {
  return entries.reduce<CategoryGroup>((acc, entry) => {
    const category = entry.data.category;
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(entry);
    return acc;
  }, {});
}

// Sort entries within each category by order
function sortCategoryEntries(grouped: CategoryGroup): CategoryGroup {
  for (const category of Object.keys(grouped)) {
    grouped[category].sort((a, b) => a.data.order - b.data.order);
  }
  return grouped;
}

// Group and sort entries by category
const mysqlByCategory = sortCategoryEntries(groupByCategory(mysqlEntries));
const mssqlByCategory = sortCategoryEntries(groupByCategory(mssqlEntries));
const oracleByCategory = sortCategoryEntries(groupByCategory(oracleEntries));
const postgresqlByCategory = sortCategoryEntries(groupByCategory(postgresqlEntries));

// Sort extras entries by order
const sortedExtras = [...extrasEntries].sort((a, b) => a.data.order - b.data.order);

// Current path to highlight active link
const currentPath = Astro.url.pathname;

// Determine active section based on current path
function getActiveSection(path: string): string {
  if (path.includes("/mssql/")) return "mssql";
  if (path.includes("/oracle/")) return "oracle";
  if (path.includes("/postgresql/")) return "postgresql";
  if (path.includes("/extras/")) return "extras";
  return "mysql";
}

const activeSection = getActiveSection(currentPath);
---

<aside class="sidebar">
  <div class="sidebar-header">
    <h3>Table of Contents</h3>
  </div>

  <div class="sidebar-search">
    <input type="text" id="sidebar-search-input" placeholder="Search documentation..." />
  </div>

  <div class="sidebar-content">
    <SidebarSection
      sectionId="mysql"
      title="MySQL"
      isActive={activeSection === "mysql"}
      currentPath={currentPath}
      entriesByCategory={mysqlByCategory}
    />

    <SidebarSection
      sectionId="mssql"
      title="MSSQL"
      isActive={activeSection === "mssql"}
      currentPath={currentPath}
      entriesByCategory={mssqlByCategory}
    />

    <SidebarSection
      sectionId="oracle"
      title="Oracle"
      isActive={activeSection === "oracle"}
      currentPath={currentPath}
      entriesByCategory={oracleByCategory}
    />

    <SidebarSection
      sectionId="postgresql"
      title="PostgreSQL"
      isActive={activeSection === "postgresql"}
      currentPath={currentPath}
      entriesByCategory={postgresqlByCategory}
    />

    <SidebarSection
      sectionId="extras"
      title="Extras"
      isActive={activeSection === "extras"}
      currentPath={currentPath}
      entries={sortedExtras}
      showCategories={false}
    />
  </div>
</aside>
