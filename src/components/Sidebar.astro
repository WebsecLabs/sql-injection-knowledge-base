---
/**
 * Sidebar component - Main navigation sidebar with collapsible sections.
 * Uses SidebarSection component to avoid code duplication.
 */
import { type CollectionEntry } from "astro:content";
import SidebarSection from "./SidebarSection.astro";
import { groupByCategory, sortGroupedEntriesInPlace } from "../utils/entryUtils";

interface Props {
  mysqlEntries: CollectionEntry<"mysql">[];
  mariadbEntries: CollectionEntry<"mariadb">[];
  mssqlEntries: CollectionEntry<"mssql">[];
  oracleEntries: CollectionEntry<"oracle">[];
  postgresqlEntries: CollectionEntry<"postgresql">[];
  extrasEntries: CollectionEntry<"extras">[];
}

const {
  mysqlEntries,
  mariadbEntries,
  mssqlEntries,
  oracleEntries,
  postgresqlEntries,
  extrasEntries,
} = Astro.props;

// Group and sort entries by category using shared utilities
const mysqlByCategory = sortGroupedEntriesInPlace(groupByCategory(mysqlEntries));
const mariadbByCategory = sortGroupedEntriesInPlace(groupByCategory(mariadbEntries));
const mssqlByCategory = sortGroupedEntriesInPlace(groupByCategory(mssqlEntries));
const oracleByCategory = sortGroupedEntriesInPlace(groupByCategory(oracleEntries));
const postgresqlByCategory = sortGroupedEntriesInPlace(groupByCategory(postgresqlEntries));

// Sort extras entries by order with stable tiebreaker
const sortedExtras = [...extrasEntries].sort(
  (a, b) => a.data.order - b.data.order || a.slug.localeCompare(b.slug)
);

// Current path to highlight active link
const currentPath = Astro.url.pathname;

// Determine active section based on current path
function getActiveSection(path: string): string {
  if (path.includes("/mariadb/")) return "mariadb";
  if (path.includes("/mssql/")) return "mssql";
  if (path.includes("/oracle/")) return "oracle";
  if (path.includes("/postgresql/")) return "postgresql";
  if (path.includes("/extras/")) return "extras";
  return "mysql";
}

const activeSection = getActiveSection(currentPath);
---

<aside class="sidebar">
  <div class="sidebar-header">
    <h3>Table of Contents</h3>
  </div>

  <div class="sidebar-search">
    <input
      type="text"
      id="sidebar-search-input"
      placeholder="Search documentation..."
      aria-label="Search documentation"
    />
  </div>

  <div class="sidebar-content">
    <SidebarSection
      sectionId="mysql"
      title="MySQL"
      isActive={activeSection === "mysql"}
      currentPath={currentPath}
      entriesByCategory={mysqlByCategory}
    />

    <SidebarSection
      sectionId="mariadb"
      title="MariaDB"
      isActive={activeSection === "mariadb"}
      currentPath={currentPath}
      entriesByCategory={mariadbByCategory}
    />

    <SidebarSection
      sectionId="mssql"
      title="MSSQL"
      isActive={activeSection === "mssql"}
      currentPath={currentPath}
      entriesByCategory={mssqlByCategory}
    />

    <SidebarSection
      sectionId="oracle"
      title="Oracle"
      isActive={activeSection === "oracle"}
      currentPath={currentPath}
      entriesByCategory={oracleByCategory}
    />

    <SidebarSection
      sectionId="postgresql"
      title="PostgreSQL"
      isActive={activeSection === "postgresql"}
      currentPath={currentPath}
      entriesByCategory={postgresqlByCategory}
    />

    <SidebarSection
      sectionId="extras"
      title="Extras"
      isActive={activeSection === "extras"}
      currentPath={currentPath}
      entries={sortedExtras}
      showCategories={false}
    />
  </div>
</aside>
