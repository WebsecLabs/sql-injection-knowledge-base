---
/**
 * Sidebar component - Main navigation sidebar with collapsible sections.
 * Uses SidebarSection component to avoid code duplication.
 */
import { type CollectionEntry } from "astro:content";
import SidebarSection from "./SidebarSection.astro";

interface Props {
  mysqlEntries: CollectionEntry<"mysql">[];
  mssqlEntries: CollectionEntry<"mssql">[];
  oracleEntries: CollectionEntry<"oracle">[];
  extrasEntries: CollectionEntry<"extras">[];
}

const { mysqlEntries, mssqlEntries, oracleEntries, extrasEntries } = Astro.props;

// Type-safe helper function to group entries by category
type AnyEntry = CollectionEntry<"mysql" | "mssql" | "oracle" | "extras">;

interface CategoryGroup {
  [category: string]: AnyEntry[];
}

function groupByCategory<T extends AnyEntry>(entries: T[]): CategoryGroup {
  return entries.reduce<CategoryGroup>((acc, entry) => {
    const category = entry.data.category;
    if (!acc[category]) {
      acc[category] = [];
    }
    acc[category].push(entry);
    return acc;
  }, {});
}

// Sort entries within each category by order
function sortCategoryEntries(grouped: CategoryGroup): CategoryGroup {
  for (const category of Object.keys(grouped)) {
    grouped[category].sort((a, b) => a.data.order - b.data.order);
  }
  return grouped;
}

// Group and sort entries by category
const mysqlByCategory = sortCategoryEntries(groupByCategory(mysqlEntries));
const mssqlByCategory = sortCategoryEntries(groupByCategory(mssqlEntries));
const oracleByCategory = sortCategoryEntries(groupByCategory(oracleEntries));

// Sort extras entries by order
const sortedExtras = [...extrasEntries].sort((a, b) => a.data.order - b.data.order);

// Current path to highlight active link
const currentPath = Astro.url.pathname;

// Determine active section based on current path
function getActiveSection(path: string): string {
  if (path.includes("/mssql/")) return "mssql";
  if (path.includes("/oracle/")) return "oracle";
  if (path.includes("/extras/")) return "extras";
  return "mysql";
}

const activeSection = getActiveSection(currentPath);
---

<aside class="sidebar">
  <div class="sidebar-header">
    <h3>Table of Contents</h3>
  </div>

  <div class="sidebar-search">
    <input type="text" id="sidebar-search-input" placeholder="Search documentation..." />
  </div>

  <div class="sidebar-content">
    <SidebarSection
      sectionId="mysql"
      title="MySQL"
      isActive={activeSection === "mysql"}
      currentPath={currentPath}
      entriesByCategory={mysqlByCategory}
    />

    <SidebarSection
      sectionId="mssql"
      title="MSSQL"
      isActive={activeSection === "mssql"}
      currentPath={currentPath}
      entriesByCategory={mssqlByCategory}
    />

    <SidebarSection
      sectionId="oracle"
      title="Oracle"
      isActive={activeSection === "oracle"}
      currentPath={currentPath}
      entriesByCategory={oracleByCategory}
    />

    <SidebarSection
      sectionId="extras"
      title="Extras"
      isActive={activeSection === "extras"}
      currentPath={currentPath}
      entries={sortedExtras}
      showCategories={false}
    />
  </div>
</aside>

<script>
  // Handle sidebar functionality
  function initSidebar() {
    // Add click handlers to sidebar headings
    document.querySelectorAll(".sidebar-heading").forEach((heading) => {
      heading.removeEventListener("click", toggleSection as EventListener);
      heading.addEventListener("click", toggleSection as EventListener);

      heading.removeEventListener("keydown", handleKeyDown as EventListener);
      heading.addEventListener("keydown", handleKeyDown as EventListener);
    });

    // Search functionality
    const searchInput = document.getElementById("sidebar-search-input");
    if (searchInput) {
      searchInput.removeEventListener("input", handleSearch as EventListener);
      searchInput.addEventListener("input", handleSearch as EventListener);
    }
  }

  // Toggle section visibility
  function toggleSection(this: HTMLElement) {
    const section = this.closest(".sidebar-section");
    if (section) {
      section.classList.toggle("active");
      const isExpanded = section.classList.contains("active");
      this.setAttribute("aria-expanded", isExpanded ? "true" : "false");
    }
  }

  // Keyboard navigation
  function handleKeyDown(this: HTMLElement, e: KeyboardEvent) {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      toggleSection.call(this);
    }
  }

  // Search functionality
  function handleSearch(this: HTMLInputElement) {
    const searchTerm = this.value.toLowerCase().trim();

    if (searchTerm.length < 2) {
      // Reset all elements if search term is too short
      document.querySelectorAll<HTMLElement>(".sidebar-nav a, .sidebar-category").forEach((el) => {
        el.style.display = "";
      });

      // Restore previous active states
      document.querySelectorAll<HTMLElement>(".sidebar-section").forEach((section) => {
        if (section.dataset.wasActive === "true") {
          section.classList.add("active");
          delete section.dataset.wasActive;
        }
      });

      return;
    }

    // Remember which sections were active before searching
    document.querySelectorAll(".sidebar-section.active").forEach((section) => {
      section.setAttribute("data-was-active", "true");
    });

    // Hide all categories initially
    document.querySelectorAll<HTMLElement>(".sidebar-category").forEach((category) => {
      category.style.display = "none";
    });

    // Hide all items initially
    document.querySelectorAll<HTMLElement>(".sidebar-nav a").forEach((link) => {
      link.style.display = "none";
    });

    // Expand all sections for search
    document.querySelectorAll(".sidebar-section").forEach((section) => {
      section.classList.add("active");
    });

    // Show matching items
    document.querySelectorAll<HTMLAnchorElement>(".sidebar-nav a").forEach((link) => {
      const text = link.textContent?.toLowerCase() || "";

      if (text.includes(searchTerm)) {
        link.style.display = "";
        const category = link.closest<HTMLElement>(".sidebar-category");
        if (category) category.style.display = "";
      }
    });
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", initSidebar);

  // Initialize after navigation with ViewTransitions
  document.addEventListener("astro:page-load", initSidebar);

  // Ensure sidebar works even if DOMContentLoaded already fired
  if (document.readyState !== "loading") {
    initSidebar();
  }
</script>
